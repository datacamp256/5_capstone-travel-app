let geonamesApiKey;
let weatherbitApiKey;
//public functions here

const tmpGeoInformationData = {
    postalCodes: [{
        placeName: "::name::",
        lat: 42,
        lng: 32,
        adminName: "::adminName1::",
        countryCode: "::countryCode::"
    }]
};

const temporalForecast = {
    "data": [
        {
            "moonrise_ts": 1602310056,
            "wind_cdir": "SSE",
            "rh": 75,
            "pres": 1010.3,
            "high_temp": 20.2,
            "sunset_ts": 1602293950,
            "ozone": 278.711,
            "moon_phase": 0.408638,
            "wind_gust_spd": 5.1,
            "snow_depth": 0,
            "clouds": 33,
            "ts": 1602226860,
            "sunrise_ts": 1602252774,
            "app_min_temp": 14.8,
            "wind_spd": 1.7679,
            "pop": 0,
            "wind_cdir_full": "south-southeast",
            "slp": 1014.31,
            "moon_phase_lunation": 0.77,
            "valid_date": "2020-10-09",
            "app_max_temp": 19.8,
            "vis": 24.1,
            "dewpt": 12.2,
            "snow": 0,
            "uv": 4.67779,
            "weather": {
                "icon": "c02d",
                "code": 802,
                "description": "Scattered clouds"
            },
            "wind_dir": 156,
            "max_dhi": null,
            "clouds_hi": 13,
            "precip": 0,
            "low_temp": 15,
            "max_temp": 20.2,
            "moonset_ts": 1602281616,
            "datetime": "2020-10-09",
            "temp": 16.9,
            "min_temp": 14.6,
            "clouds_mid": 11,
            "clouds_low": 23
        },
        {
            "moonrise_ts": 1602313365,
            "wind_cdir": "WSW",
            "rh": 74,
            "pres": 1011.09,
            "high_temp": 23,
            "sunset_ts": 1602380265,
            "ozone": 266.135,
            "moon_phase": 0.302344,
            "wind_gust_spd": 7.5,
            "snow_depth": 0,
            "clouds": 48,
            "ts": 1602313260,
            "sunrise_ts": 1602339229,
            "app_min_temp": 15.7,
            "wind_spd": 2.43054,
            "pop": 0,
            "wind_cdir_full": "west-southwest",
            "slp": 1015.1,
            "moon_phase_lunation": 0.81,
            "valid_date": "2020-10-10",
            "app_max_temp": 22.8,
            "vis": 24.1,
            "dewpt": 13.4,
            "snow": 0,
            "uv": 5.1007,
            "weather": {
                "icon": "c03d",
                "code": 803,
                "description": "Broken clouds"
            },
            "wind_dir": 248,
            "max_dhi": null,
            "clouds_hi": 38,
            "precip": 0,
            "low_temp": 14.2,
            "max_temp": 23.3,
            "moonset_ts": 1602370697,
            "datetime": "2020-10-10",
            "temp": 18.5,
            "min_temp": 15.7,
            "clouds_mid": 8,
            "clouds_low": 24
        },
        {
            "moonrise_ts": 1602403473,
            "wind_cdir": "WNW",
            "rh": 59,
            "pres": 1008.28,
            "high_temp": 21.9,
            "sunset_ts": 1602466580,
            "ozone": 259.321,
            "moon_phase": 0.202622,
            "wind_gust_spd": 7.1316,
            "snow_depth": 0,
            "clouds": 12,
            "ts": 1602399660,
            "sunrise_ts": 1602425684,
            "app_min_temp": 14.6,
            "wind_spd": 2.12908,
            "pop": 0,
            "wind_cdir_full": "west-northwest",
            "slp": 1016.62,
            "moon_phase_lunation": 0.84,
            "valid_date": "2020-10-11",
            "app_max_temp": 21.3,
            "vis": 23.9949,
            "dewpt": 9.5,
            "snow": 0,
            "uv": 5.97866,
            "weather": {
                "icon": "c02d",
                "code": 801,
                "description": "Few clouds"
            },
            "wind_dir": 295,
            "max_dhi": null,
            "clouds_hi": 12,
            "precip": 0,
            "low_temp": 14.6,
            "max_temp": 22.6,
            "moonset_ts": 1602459493,
            "datetime": "2020-10-11",
            "temp": 17.9,
            "min_temp": 14.5,
            "clouds_mid": 0,
            "clouds_low": 0
        },
        {
            "moonrise_ts": 1602493891,
            "wind_cdir": "WNW",
            "rh": 52,
            "pres": 1009.37,
            "high_temp": 24.6,
            "sunset_ts": 1602552896,
            "ozone": 267.216,
            "moon_phase": 0.116245,
            "wind_gust_spd": 5.42361,
            "snow_depth": 0,
            "clouds": 0,
            "ts": 1602486060,
            "sunrise_ts": 1602512139,
            "app_min_temp": 14.7,
            "wind_spd": 1.72806,
            "pop": 0,
            "wind_cdir_full": "west-northwest",
            "slp": 1017.75,
            "moon_phase_lunation": 0.87,
            "valid_date": "2020-10-12",
            "app_max_temp": 24,
            "vis": 24.135,
            "dewpt": 8.5,
            "snow": 0,
            "uv": 5.89402,
            "weather": {
                "icon": "c01d",
                "code": 800,
                "description": "Clear Sky"
            },
            "wind_dir": 303,
            "max_dhi": null,
            "clouds_hi": 0,
            "precip": 0,
            "low_temp": 14.7,
            "max_temp": 24.9,
            "moonset_ts": 1602548059,
            "datetime": "2020-10-12",
            "temp": 18.7,
            "min_temp": 14.6,
            "clouds_mid": 0,
            "clouds_low": 0
        },
        {
            "moonrise_ts": 1602584512,
            "wind_cdir": "WNW",
            "rh": 57,
            "pres": 1008.11,
            "high_temp": 27.7,
            "sunset_ts": 1602639213,
            "ozone": 268.276,
            "moon_phase": 0.0502398,
            "wind_gust_spd": 5.30801,
            "snow_depth": 0,
            "clouds": 24,
            "ts": 1602572460,
            "sunrise_ts": 1602598595,
            "app_min_temp": 15.8,
            "wind_spd": 1.1032,
            "pop": 0,
            "wind_cdir_full": "west-northwest",
            "slp": 1016.51,
            "moon_phase_lunation": 0.91,
            "valid_date": "2020-10-13",
            "app_max_temp": 26,
            "vis": 24.135,
            "dewpt": 9.7,
            "snow": 0,
            "uv": 4.3663,
            "weather": {
                "icon": "c02d",
                "code": 802,
                "description": "Scattered clouds"
            },
            "wind_dir": 302,
            "max_dhi": null,
            "clouds_hi": 24,
            "precip": 0,
            "low_temp": 15.8,
            "max_temp": 27.1,
            "moonset_ts": 1602636475,
            "datetime": "2020-10-13",
            "temp": 19,
            "min_temp": 15.7,
            "clouds_mid": 0,
            "clouds_low": 0
        },
        {
            "moonrise_ts": 1602675251,
            "wind_cdir": "WNW",
            "rh": 44,
            "pres": 1007.88,
            "high_temp": 31.6,
            "sunset_ts": 1602725531,
            "ozone": 257.242,
            "moon_phase": 0.0108361,
            "wind_gust_spd": 5.12763,
            "snow_depth": 0,
            "clouds": 33,
            "ts": 1602658860,
            "sunrise_ts": 1602685051,
            "app_min_temp": 18.2,
            "wind_spd": 1.71839,
            "pop": 0,
            "wind_cdir_full": "west-northwest",
            "slp": 1016.01,
            "moon_phase_lunation": 0.94,
            "valid_date": "2020-10-14",
            "app_max_temp": 26.9,
            "vis": 24.1349,
            "dewpt": 9.3,
            "snow": 0,
            "uv": 5.35968,
            "weather": {
                "icon": "c02d",
                "code": 802,
                "description": "Scattered clouds"
            },
            "wind_dir": 288,
            "max_dhi": null,
            "clouds_hi": 33,
            "precip": 0,
            "low_temp": 19.6,
            "max_temp": 28.6,
            "moonset_ts": 1602724830,
            "datetime": "2020-10-14",
            "temp": 22.4,
            "min_temp": 18.3,
            "clouds_mid": 0,
            "clouds_low": 0
        },
        {
            "moonrise_ts": 1602766063,
            "wind_cdir": "S",
            "rh": 22,
            "pres": 1005.99,
            "high_temp": 33,
            "sunset_ts": 1602811849,
            "ozone": 252.938,
            "moon_phase": 0.00227091,
            "wind_gust_spd": 3.22116,
            "snow_depth": 0,
            "clouds": 0,
            "ts": 1602745260,
            "sunrise_ts": 1602771507,
            "app_min_temp": 18.2,
            "wind_spd": 1.19773,
            "pop": 0,
            "wind_cdir_full": "south",
            "slp": 1014.25,
            "moon_phase_lunation": 0.98,
            "valid_date": "2020-10-15",
            "app_max_temp": 29.4,
            "vis": 24.135,
            "dewpt": 0.5,
            "snow": 0,
            "uv": 5.31445,
            "weather": {
                "icon": "c01d",
                "code": 800,
                "description": "Clear Sky"
            },
            "wind_dir": 191,
            "max_dhi": null,
            "clouds_hi": 0,
            "precip": 0,
            "low_temp": 20.8,
            "max_temp": 32.2,
            "moonset_ts": 1602813219,
            "datetime": "2020-10-15",
            "temp": 24.6,
            "min_temp": 19.2,
            "clouds_mid": 0,
            "clouds_low": 0
        },
        {
            "moonrise_ts": 1602856937,
            "wind_cdir": "S",
            "rh": 19,
            "pres": 1004.48,
            "high_temp": 33.8,
            "sunset_ts": 1602898169,
            "ozone": 250.986,
            "moon_phase": 0.0258286,
            "wind_gust_spd": 2.50492,
            "snow_depth": 0,
            "clouds": 0,
            "ts": 1602831660,
            "sunrise_ts": 1602857964,
            "app_min_temp": 19.5,
            "wind_spd": 1.00492,
            "pop": 0,
            "wind_cdir_full": "south",
            "slp": 1012.92,
            "moon_phase_lunation": 0.01,
            "valid_date": "2020-10-16",
            "app_max_temp": 30.6,
            "vis": 24.135,
            "dewpt": 0.2,
            "snow": 0,
            "uv": 5.25301,
            "weather": {
                "icon": "c01d",
                "code": 800,
                "description": "Clear Sky"
            },
            "wind_dir": 186,
            "max_dhi": null,
            "clouds_hi": 0,
            "precip": 0,
            "low_temp": 21.9,
            "max_temp": 33.9,
            "moonset_ts": 1602901741,
            "datetime": "2020-10-16",
            "temp": 26,
            "min_temp": 20.4,
            "clouds_mid": 0,
            "clouds_low": 0
        },
        {
            "moonrise_ts": 1602947868,
            "wind_cdir": "SW",
            "rh": 19,
            "pres": 1003.85,
            "high_temp": 27.7,
            "sunset_ts": 1602984489,
            "ozone": 252.533,
            "moon_phase": 0.0258286,
            "wind_gust_spd": 3.82791,
            "snow_depth": 0,
            "clouds": 0,
            "ts": 1602918060,
            "sunrise_ts": 1602944421,
            "app_min_temp": 20.8,
            "wind_spd": 1.07974,
            "pop": 0,
            "wind_cdir_full": "southwest",
            "slp": 1012.44,
            "moon_phase_lunation": 0.04,
            "valid_date": "2020-10-17",
            "app_max_temp": 31.3,
            "vis": 24.135,
            "dewpt": 0.7,
            "snow": 0,
            "uv": 5.19283,
            "weather": {
                "icon": "c01d",
                "code": 800,
                "description": "Clear Sky"
            },
            "wind_dir": 231,
            "max_dhi": null,
            "clouds_hi": 0,
            "precip": 0,
            "low_temp": 21.9,
            "max_temp": 35,
            "moonset_ts": 1602988141,
            "datetime": "2020-10-17",
            "temp": 26.8,
            "min_temp": 21.6,
            "clouds_mid": 0,
            "clouds_low": 0
        },
        {
            "moonrise_ts": 1603038823,
            "wind_cdir": "SSE",
            "rh": 24,
            "pres": 1005.11,
            "high_temp": 26.2,
            "sunset_ts": 1603070810,
            "ozone": 253.385,
            "moon_phase": 0.0794715,
            "wind_gust_spd": 1.13226,
            "snow_depth": 0,
            "clouds": 15,
            "ts": 1603004460,
            "sunrise_ts": 1603030879,
            "app_min_temp": 20.8,
            "wind_spd": 0.619855,
            "pop": 0,
            "wind_cdir_full": "south-southeast",
            "slp": 1013.66,
            "moon_phase_lunation": 0.08,
            "valid_date": "2020-10-18",
            "app_max_temp": 26.5,
            "vis": 24.1351,
            "dewpt": 1.6,
            "snow": 0,
            "uv": 3.73731,
            "weather": {
                "icon": "c02d",
                "code": 801,
                "description": "Few clouds"
            },
            "wind_dir": 164,
            "max_dhi": null,
            "clouds_hi": 15,
            "precip": 0,
            "low_temp": 20.6,
            "max_temp": 30.2,
            "moonset_ts": 1603076897,
            "datetime": "2020-10-18",
            "temp": 23.6,
            "min_temp": 20.9,
            "clouds_mid": 0,
            "clouds_low": 0
        },
        {
            "moonrise_ts": 1603129709,
            "wind_cdir": "NW",
            "rh": 25,
            "pres": 1007.29,
            "high_temp": 24.3,
            "sunset_ts": 1603157132,
            "ozone": 244.252,
            "moon_phase": 0.158218,
            "wind_gust_spd": 0.741835,
            "snow_depth": 0,
            "clouds": 0,
            "ts": 1603090860,
            "sunrise_ts": 1603117337,
            "app_min_temp": 21.3,
            "wind_spd": 0.615723,
            "pop": 0,
            "wind_cdir_full": "northwest",
            "slp": 1015.74,
            "moon_phase_lunation": 0.11,
            "valid_date": "2020-10-19",
            "app_max_temp": 26.1,
            "vis": 24.1352,
            "dewpt": 2.8,
            "snow": 0,
            "uv": 4.42883,
            "weather": {
                "icon": "c01d",
                "code": 800,
                "description": "Clear Sky"
            },
            "wind_dir": 305,
            "max_dhi": null,
            "clouds_hi": 0,
            "precip": 0,
            "low_temp": 21.7,
            "max_temp": 29.3,
            "moonset_ts": 1603165974,
            "datetime": "2020-10-19",
            "temp": 24.6,
            "min_temp": 18.9,
            "clouds_mid": 0,
            "clouds_low": 0
        },
        {
            "moonrise_ts": 1603220371,
            "wind_cdir": "NW",
            "rh": 32,
            "pres": 1008.48,
            "high_temp": 22.1,
            "sunset_ts": 1603243455,
            "ozone": 249.18,
            "moon_phase": 0.255128,
            "wind_gust_spd": 2.30779,
            "snow_depth": 0,
            "clouds": 42,
            "ts": 1603177260,
            "sunrise_ts": 1603203795,
            "app_min_temp": 19.7,
            "wind_spd": 1.39354,
            "pop": 0,
            "wind_cdir_full": "northwest",
            "slp": 1016.92,
            "moon_phase_lunation": 0.15,
            "valid_date": "2020-10-20",
            "app_max_temp": 24.1,
            "vis": 24.135,
            "dewpt": 5.1,
            "snow": 0,
            "uv": 4.39514,
            "weather": {
                "icon": "c03d",
                "code": 803,
                "description": "Broken clouds"
            },
            "wind_dir": 310,
            "max_dhi": null,
            "clouds_hi": 42,
            "precip": 0,
            "low_temp": 20.6,
            "max_temp": 26.1,
            "moonset_ts": 1603255421,
            "datetime": "2020-10-20",
            "temp": 22.7,
            "min_temp": 18.3,
            "clouds_mid": 0,
            "clouds_low": 0
        },
        {
            "moonrise_ts": 1603310635,
            "wind_cdir": "SSE",
            "rh": 29,
            "pres": 1007.49,
            "high_temp": 27.5,
            "sunset_ts": 1603329779,
            "ozone": 248.22,
            "moon_phase": 0.362548,
            "wind_gust_spd": 1.64435,
            "snow_depth": 0,
            "clouds": 0,
            "ts": 1603263660,
            "sunrise_ts": 1603290254,
            "app_min_temp": 20.9,
            "wind_spd": 0.746803,
            "pop": 0,
            "wind_cdir_full": "south-southeast",
            "slp": 1016.05,
            "moon_phase_lunation": 0.18,
            "valid_date": "2020-10-21",
            "app_max_temp": 24.1,
            "vis": 24.1351,
            "dewpt": 4.1,
            "snow": 0,
            "uv": 4.3241,
            "weather": {
                "icon": "c01d",
                "code": 800,
                "description": "Clear Sky"
            },
            "wind_dir": 161,
            "max_dhi": null,
            "clouds_hi": 0,
            "precip": 0,
            "low_temp": 19.6,
            "max_temp": 27.5,
            "moonset_ts": 1603345213,
            "datetime": "2020-10-21",
            "temp": 23.4,
            "min_temp": 19.6,
            "clouds_mid": 0,
            "clouds_low": 0
        },
        {
            "moonrise_ts": 1603400386,
            "wind_cdir": "NW",
            "rh": 26,
            "pres": 1007.03,
            "high_temp": 28.9,
            "sunset_ts": 1603416104,
            "ozone": 232.907,
            "moon_phase": 0.473271,
            "wind_gust_spd": 1.10183,
            "snow_depth": 0,
            "clouds": 0,
            "ts": 1603350060,
            "sunrise_ts": 1603376712,
            "app_min_temp": 20.7,
            "wind_spd": 0.766885,
            "pop": 0,
            "wind_cdir_full": "northwest",
            "slp": 1015.55,
            "moon_phase_lunation": 0.21,
            "valid_date": "2020-10-22",
            "app_max_temp": 25.4,
            "vis": 24.1352,
            "dewpt": 3,
            "snow": 0,
            "uv": 4.35513,
            "weather": {
                "icon": "c01d",
                "code": 800,
                "description": "Clear Sky"
            },
            "wind_dir": 312,
            "max_dhi": null,
            "clouds_hi": 0,
            "precip": 0,
            "low_temp": 18.9,
            "max_temp": 28.9,
            "moonset_ts": 1603435248,
            "datetime": "2020-10-22",
            "temp": 23.9,
            "min_temp": 18.9,
            "clouds_mid": 0,
            "clouds_low": 0
        },
        {
            "moonrise_ts": 1603489609,
            "wind_cdir": "SSE",
            "rh": 30,
            "pres": 1006.83,
            "high_temp": 27.6,
            "sunset_ts": 1603502430,
            "ozone": 237.4,
            "moon_phase": 0.581321,
            "wind_gust_spd": 1.64398,
            "snow_depth": 0,
            "clouds": 5,
            "ts": 1603436460,
            "sunrise_ts": 1603463172,
            "app_min_temp": 19.7,
            "wind_spd": 0.720241,
            "pop": 0,
            "wind_cdir_full": "south-southeast",
            "slp": 1015.27,
            "moon_phase_lunation": 0.25,
            "valid_date": "2020-10-23",
            "app_max_temp": 23.4,
            "vis": 24.1351,
            "dewpt": 3.9,
            "snow": 0,
            "uv": 4.31197,
            "weather": {
                "icon": "c02d",
                "code": 801,
                "description": "Few clouds"
            },
            "wind_dir": 168,
            "max_dhi": null,
            "clouds_hi": 5,
            "precip": 0,
            "low_temp": 17.1,
            "max_temp": 27.6,
            "moonset_ts": 1603438983,
            "datetime": "2020-10-23",
            "temp": 22.4,
            "min_temp": 17.1,
            "clouds_mid": 0,
            "clouds_low": 0
        },
        {
            "moonrise_ts": 1603578371,
            "wind_cdir": "WNW",
            "rh": 47,
            "pres": 1005.59,
            "high_temp": null,
            "sunset_ts": 1603588757,
            "ozone": 241.741,
            "moon_phase": 0.682213,
            "wind_gust_spd": 1.42822,
            "snow_depth": 0,
            "clouds": 0,
            "ts": 1603522860,
            "sunrise_ts": 1603549631,
            "app_min_temp": 21.6,
            "wind_spd": 1.10661,
            "pop": 0,
            "wind_cdir_full": "west-northwest",
            "slp": 1014.5,
            "moon_phase_lunation": 0.28,
            "valid_date": "2020-10-24",
            "app_max_temp": 21.6,
            "vis": 24.1349,
            "dewpt": 10.4,
            "snow": 0,
            "uv": 4.24002,
            "weather": {
                "icon": "c01d",
                "code": 800,
                "description": "Clear Sky"
            },
            "wind_dir": 285,
            "max_dhi": null,
            "clouds_hi": 0,
            "precip": 0,
            "low_temp": null,
            "max_temp": 22.1,
            "moonset_ts": 1603529099,
            "datetime": "2020-10-24",
            "temp": 22.1,
            "min_temp": 22.1,
            "clouds_mid": 0,
            "clouds_low": 0
        }
    ],
    "city_name": "::Mountain View::",
    "lon": -122.08,
    "timezone": "America\/Los_Angeles",
    "lat": 37.41,
    "country_code": "US",
    "state_code": "CA"
};

async function loadGeonamesApiKey() {
    const promisedKeys = ['geonames', 'weatherbit'].map(async serviceId =>
        fetch('http://localhost:8081/loadApiKey?application=' + serviceId)
            .then(response => response.text())
    );
    [geonamesApiKey, weatherbitApiKey] = await Promise.all(promisedKeys);
}

async function loadGeoInformation(zipCode) {
    const url = createGeoInformationRequestAddress(zipCode);
    //const result = await fetch(url).then(response => response.json()); //TODO replace later
    const result = tmpGeoInformationData;
    console.log(result);
    return extractLocationProperties(result);
}

async function loadWeatherForecast(lat, lng) {
    const url = `https://api.weatherbit.io/v2.0/forecast/daily?key=${weatherbitApiKey}&lat=${lat}&lon=${lng}`;
    // const weatherbitForecast = await fetch(url).then(response => response.json()); //TODO replace later
    const weatherbitForecast = temporalForecast;
    return extractWeatherForecast(weatherbitForecast);
}

// private functions here

function extractWeatherForecast(weatherbitForecast) {
    const forecasts = {days:[]};
    weatherbitForecast.data.forEach(day =>{
       forecasts.days.push({
           valid_date: day.valid_date,
           icon: day.weather.icon,
           description: day.weather.description,
           temp: day.temp,
           probability_of_precipitation: day.pop,
           wind_spd: day.wind_spd,
           wind_direction: day.wind_cdir_full
       })
    });
    return forecasts;
}

function extractLocationProperties(result) {
    return {
        location: result.postalCodes[0].placeName,
        lat: result.postalCodes[0].lat,
        lng: result.postalCodes[0].lng,
        region: result.postalCodes[0].adminName1,
        country: result.postalCodes[0].countryCode
    };
}

function createGeoInformationRequestAddress(zipCode) {
    const parameters = [
        `username=${geonamesApiKey}`,
        `placename=${encodeURIComponent(zipCode)}`,
        'maxRows=10',
        'style=MEDIUM',
        'countryBias=US',
        'countryBias=DE',
        'countryBias=IN',
    ];
    return 'http://api.geonames.org/postalCodeSearchJSON?' + parameters.join('&');
}

// exports
module.exports.backend_loadGeonamesApiKey = loadGeonamesApiKey;
module.exports.backend_loadGeoInformation = loadGeoInformation;
module.exports.fetcher_loadWeatherForecast = loadWeatherForecast;
